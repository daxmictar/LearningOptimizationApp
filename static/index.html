<!DOCTYPE html>
<html>
    <head>
	     <script src="https://code.jquery.com/jquery-3.6.0.js" 
		     integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    </head>
    <body>

	<script>
		function play_start(current_video){
			$.post("/open_api/play_movie", { "data" : current_video},
				function(data, textStatus) {
					//this gets called when browser receives response from server
					console.log(data);
				}, "json").fail( function(response) {
					//this gets called if the server throws an error
					console.log("error");
				console.log(response);});
		}

		function attention_start() {
			// make a POST to start_attention to start data collection for attention
			// related services
			$.post("/open_api/start_attention", { "data" : "Starting Attention Collection" }, 
				(data, textStatus) => {
					console.log(data)
				}, 
				"json")
				.fail ((response) => console.log("start_attention call failed"));
		}

		/*
		 * @description On video end make a call to the server
		 * @param previous_video The src of the previously played video that just ended  
		 */
		function play_end(previous_video, handsoff){
			if(handsoff == "On"){
				$.post("/open_api/next_video", {"data" : previous_video, "handsoff" : handsoff, "AttentionRating" : 1, "PreferenceRating" : 1},
					function(data, textStatus) {
						//Gets called when browser recieves response from server
						console.log("DATA: ");
						console.log(data);
						
						//Grab the video and the video source
						video = document.getElementById("video")
						video_source = document.getElementById("video_source")
						
						//Set the source to the new video recieved from server
						video_source.setAttribute("src", data);

						//Load the video
						video.load();

						if(data[1] == "On"){
							//Redirect to post video survey
							window.location.href = 'index.html?last_video=' + data[0] + '&handsoff=' + data[1];
						}
					}, "json").fail(function(response){
						console.log("Error");
						console.log(response);
					});
			} else {
				$.post("/open_api/end_movie", {"data" : previous_video},
					function(data, textStatus) {
						//Gets called when browser recieves response from server
						console.log("DATA: ");
						console.log(data);
						
						//Grab the video and the video source
						video = document.getElementById("video")
						video_source = document.getElementById("video_source")
						
						//Set the source to the new video recieved from server
						video_source.setAttribute("src", data);

						//Load the video
						video.load();

						//Redirect to post video survey
						window.location.href = 'post_video_survey.html?last_video=' + data[0];
					}, "json").fail(function(response){
						console.log("Error");
						console.log(response);
					});
			}
		}

		function attention_stop() {
			// make a POST to start_attention to start data collection for attention
			// related services
			$.post("/open_api/end_attention", { "data" : "Ending Attention Collection" }, 
				(data, textStatus) => {
					console.log(data)
				}, 
				"json")
				.fail ((response) => console.log("end_attention call failed"));
		}

		function attention_clear() {
			// make a POST to clear_attention_data to clear data collection for attention
			// related services
			$.post("/open_api/clear_attention_data", { "data" : "Filling Attention Collection" }, 
				(data, textStatus) => {
					console.log(data)
				}, 
				"json")
				.fail ((response) => console.log("end_attention call failed"));
		}

		function loadDebugMode() {
            // check for ?debug_mode=true	
            const urlParams = new URLSearchParams(window.location.search);
            const isInDebugMode = urlParams.has("debug_mode") && (urlParams.get("debug_mode") === "true");
            console.log("Is index.html in debug_mode? == " + isInDebugMode);

            const userAgent = navigator.userAgent;
			const validBrowser = userAgent.includes("Chrome") || userAgent.includes("Edge") || userAgent.includes("Firefox");
			console.log("Is browser valid? == " + validBrowser);

			const generateVideoList = () => {
				return new Promise((resolve, reject) => {
					$.post("/open_api/get_mp4s", { "data": "Requesting MP4s from static dir" },
						(data, textStatus) => {
							console.log("Got MP4s: " + data);
							resolve(data);
						} 
					)
					.fail(response => {
						console.log(response);
						reject(response);
					});
				});
			};

            if (validBrowser && isInDebugMode) {
             	const movieDropDown = document.getElementById("Movies");
				generateVideoList()
					.then((videos) => {
						// const listDirButton = document.getElementById("listDirectoryButton");
						const movieDropDown = document.getElementById("Movies");
						for (const mp4 of videos) {
							const listItem = document.createElement("option");
							listItem.value = mp4;
							listItem.textContent = mp4;
							movieDropDown.appendChild(listItem);
						}
					});
    		} else {
				document
					.getElementById("Movies")
					.style = "visibility:hidden";

				document
					.getElementById("selectMovieButton")
					.style = "visibility:hidden";
			}
		}

		function getSelectedText(elementId) {
			// jquery function to get the text of a selected element
			var selected_text = $("#" + elementId + " option:selected").text();
			
			if (!selected_text) {
				return null;
			}

			return selected_text;
		}
	</script>

	<center>
		<video id="video" width="640" height="480" controls>
			<source id="video_source" src="Algebra_1_Help_MathHelp.mp4" type="video/mp4">
				Your browser does not support the video tag.
		</video>

		<center>
			<button id="HandsOffMode">Handsoff Mode: Off</button>
		</center>

		<select name="Movies" id="Movies">Movies</select>
		<button id="selectMovieButton">Select Movie</button>
	</center>

	<script>
		//Listens for a video start and issues a call that sends previous video to server via play_end function.
		video.addEventListener("play", (event) => {
			//Send the current videos name to server
			var current_video = document.getElementById("video_source").getAttribute("src")
			play_start(current_video);
			attention_start();

			//Hide the video controls when the video is first played
			document.getElementById("video").controls = false;

			//Hide the option to toggle the offhands mode while a video is playing
			//This is done to reduce distractions during video consumption
			document.getElementById("HandsOffMode").style.display = 'none';
		});
		
		//Listens for a video end and issues a call that sends previous video to server via play_end function.
		//Also stops headband feed if it is open
		video.addEventListener("ended", (event) => {
			//Set the previous videos name to the server
			var prev_video = document.getElementById("video_source").getAttribute("src")
			console.log("Source in Listener: ");
			console.log(prev_video);

			//Get the url param for handsoff
			const urlParams = new URLSearchParams(window.location.search);
            const handsoff = urlParams.get('handsoff');

			//Pass in the previous video and state of handsoff mode to the post function
			play_end(prev_video, handsoff);
			attention_stop();
		});

		document.getElementById("HandsOffMode").addEventListener("click", () => {
			const urlParams = new URLSearchParams(window.location.search);
            var handsoff = urlParams.get('handsoff');

			//If hands off is found and is on
			if(handsoff == "On"){
				//Turn it off and refresh the page
				handsoff = "Off"
			} else {
				//If it is off then we turn it on and reload the page
				handsoff = "On"
				//Set the param
			}

			const debug = urlParams.get('debug_mode');

			console.log("Handsoff Mode: " + handsoff + "\nDebug Mode: " + debug);

			window.location.href = 'index.html?debug=' + debug + '&handsoff=' + handsoff;
			
		});

		document.getElementById("selectMovieButton").addEventListener("click", () => {
            var video = document.getElementById("video")
			var video_src = document.getElementById("video_source")

			// use helper function to get the currently selected text from drop down
			video_src.setAttribute("src", getSelectedText("Movies"));

            //Load the video
            video.load();
		});

		window.onload = function(){
			console.log("Grabbing location: " + window.location);
			const urlParams = new URLSearchParams(window.location.search);
            const variable = urlParams.get('next_video');
            console.log("Grabbing variable: " + variable);

			loadDebugMode();
			
			//Check for debug variable being passed in for debug mode
			if(variable != null){
				//Grab the video and the video source
				video = document.getElementById("video");
				video_source = document.getElementById("video_source");
				
				//Set the source to the new video recieved from server
				video_source.setAttribute("src", variable);

				//Load the video
				video.load();
			}

			var last_video = urlParams.get("last_video")
			console.log("Last Video: " + last_video)
			if(last_video != null){
				//Grab the video and the video source
				video = document.getElementById("video");
				video_source = document.getElementById("video_source");
				
				//Set the source to the new video recieved from server
				video_source.setAttribute("src", last_video);

				//Load the video
				video.load();
				video.play();
			}

			//Check for handsfree mode being passed in for handsfree mode
			var handsoff = urlParams.get('handsoff');
			console.log("Handsoff Mode = " + handsoff);

			if(handsoff != null){
				if(handsoff == 'On'){
					//Turn off video controls if in hands free mode
					document.getElementById("video").controls = false;

					//Set the text on the button to the correct value
					document.getElementById("HandsOffMode").innerHTML = "Handsoff Mode: On"

					//Set the button to invisible
					document.getElementById("HandsOffMode").display = 'none';

					document.getElementById("video").play();
				}
			}
		}
	</script>

    </body>
</html>

